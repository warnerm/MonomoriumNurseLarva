
SPECIES = ["Mphar","Amel","Nvit"]
TAXID = ["307658","7460","7425"]
THREADS = 20

rule all:
	input: expand("../results/{test}_{ref}_HYM",zip,test=SPECIES,ref=TAXID)

rule makeOGGlist:
	input: "../data/{ref}.fs"
	output: "../data/{ref}.tab"
	shell: """grep "\t{wildcards.ref}:" ../data/odb9_OG2genes.tab > {output}"""

#Make blast database for each ODB9 protein file
rule makeBlastDB_OGG:
	input: "../data/{ref}.fs"
	output: "../temp/{ref}.phr"
	shell: "makeblastdb -in {input} -dbtype prot -out ../temp/{wildcards.ref}"

#Perform genome-wide pairwise blast from NCBI protein files to ODB9 protein files to establish which OGGs to compare to
rule pairwiseBlast:
	input: ref="../temp/{ref}.phr",test="../data/{test}_prot.fa"
	output: "../results/{ref}_{test}_blastRes.tab"
	shell: "python2.7 pairwiseBlast.py -s {input[test]} -d {input[ref]} -t {THREADS} -o {output}"


#Get Endopterygota OGGs. "EOG091B" is the prefix for all endopterygota genes
rule endOGG:
	input: geneList="../results/{ref}_{test}_blastRes.tab", oggList="../data/{ref}.tab"
	output: "../results/{test}_{ref}_HYM"
	shell: "sed 's/gnl.* //' {input[geneList]} | awk {{'print$2'}} | sort | uniq > ../temp/geneEdit; python2.7 getOGG.py ../temp/geneEdit {output} {THREADS} {input[oggList]} EOG091B"

#Next, need to combine OGG lists using R, keeping the protein IDs. Then can write python script to go line-by-line, get the proteins from each species, do aligning, etc, then do PAML.